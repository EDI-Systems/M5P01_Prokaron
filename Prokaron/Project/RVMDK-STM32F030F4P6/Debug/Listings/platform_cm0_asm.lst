


ARM Macro Assembler    Page 1 


    1 00000000         ;/******************************************************
                       ***********************
    2 00000000         ;Filename    : platform_cm0_asm.s
    3 00000000         ;Author      : pry
    4 00000000         ;Date        : 10/04/2012
    5 00000000         ;Description : The assembly part of the RMP RTOS. This i
                       s for Cortex-M0/0+/1.
    6 00000000         ;*******************************************************
                       **********************/
    7 00000000         
    8 00000000         ;/* The ARM Cortex-M Structure *************************
                       ***********************
    9 00000000         ;R0-R7:General purpose registers that are accessible. 
   10 00000000         ;R8-R12:general purpose registers that can only be reach
                       ed by 32-bit instructions.
   11 00000000         ;R13:SP/SP_process/SP_main    Stack pointer
   12 00000000         ;R14:LR                       Link Register(used for ret
                       urning from a subfunction)
   13 00000000         ;R15:PC                       Program counter.
   14 00000000         ;IPSR                         Interrupt Program Status R
                       egister.
   15 00000000         ;APSR                         Application Program Status
                        Register.
   16 00000000         ;EPSR                         Execute Program Status Reg
                       ister.
   17 00000000         ;The above 3 registers are saved into the stack in combi
                       nation(xPSR).
   18 00000000         ;*******************************************************
                       **********************/
   19 00000000         
   20 00000000         ;/* Begin Header ***************************************
                       **********************/
   21 00000000         ;The align is "(2^3)/8=1(Byte)." In fact it does not tak
                       e effect.            
   22 00000000                 AREA             ARCH,CODE,READONLY,ALIGN=3
   23 00000000         
   24 00000000                 THUMB
   25 00000000                 REQUIRE8
   26 00000000                 PRESERVE8
   27 00000000         ;/* End Header *****************************************
                       **********************/
   28 00000000         
   29 00000000         ;/* Begin Exports **************************************
                       **********************/
   30 00000000         ;Disable all interrupts
   31 00000000                 EXPORT           RMP_Disable_Int
   32 00000000         ;Enable all interrupts            
   33 00000000                 EXPORT           RMP_Enable_Int
   34 00000000         ;Mask/unmask interrupt dummy
   35 00000000                 EXPORT           RMP_Mask_Int
   36 00000000         ;Get the MSB                              
   37 00000000                 EXPORT           RMP_MSB_Get
   38 00000000         ;Start the first thread
   39 00000000                 EXPORT           _RMP_Start
   40 00000000         ;The PendSV trigger
   41 00000000                 EXPORT           _RMP_Yield
   42 00000000         ;The system pending service routine              
   43 00000000                 EXPORT           PendSV_Handler
   44 00000000         ;The systick timer routine              



ARM Macro Assembler    Page 2 


   45 00000000                 EXPORT           SysTick_Handler
   46 00000000         ;/* End Exports ****************************************
                       **********************/
   47 00000000         
   48 00000000         ;/* Begin Imports **************************************
                       **********************/
   49 00000000         ;The real task switch handling function
   50 00000000                 IMPORT           _RMP_Get_High_Rdy
   51 00000000         ;The real systick handler function
   52 00000000                 IMPORT           _RMP_Tick_Handler
   53 00000000         ;The PID of the current thread                     
   54 00000000                 IMPORT           RMP_Cur_Thd
   55 00000000         ;The stack address of current thread
   56 00000000                 IMPORT           RMP_Cur_SP
   57 00000000         ;Save and load extra contexts, such as FPU, peripherals 
                       and MPU
   58 00000000                 IMPORT           RMP_Save_Ctx
   59 00000000                 IMPORT           RMP_Load_Ctx
   60 00000000         ;/* End Imports ****************************************
                       **********************/
   61 00000000         
   62 00000000         ;/* Begin Function:RMP_Disable_Int *********************
                       ***********************
   63 00000000         ;Description    : The function for disabling all interru
                       pts. Does not allow nesting.
   64 00000000         ;Input          : None.
   65 00000000         ;Output         : None.    
   66 00000000         ;Register Usage : None.                                 
                        
   67 00000000         ;*******************************************************
                       **********************/    
   68 00000000         RMP_Disable_Int
   69 00000000         ;Disable all interrupts (I is primask,F is Faultmask.)
   70 00000000 B672            CPSID            I
   71 00000002 4770            BX               LR
   72 00000004         ;/* End Function:RMP_Disable_Int ***********************
                       **********************/
   73 00000004         
   74 00000004         ;/* Begin Function:RMP_Enable_Int **********************
                       ***********************
   75 00000004         ;Description    : The function for enabling all interrup
                       ts. Does not allow nesting.
   76 00000004         ;Input          : None.
   77 00000004         ;Output         : None.    
   78 00000004         ;Register Usage : None.                                 
                        
   79 00000004         ;*******************************************************
                       **********************/
   80 00000004         RMP_Enable_Int
   81 00000004         ;Enable all interrupts.
   82 00000004 B662            CPSIE            I
   83 00000006 4770            BX               LR
   84 00000008         ;/* End Function:RMP_Enable_Int ************************
                       **********************/
   85 00000008         
   86 00000008         ;/* Begin Function:RMP_Mask_Int ************************
                       ***********************
   87 00000008         ;Description    : Cortex-M0 does not allow masking and t
                       his is provided as dummy.



ARM Macro Assembler    Page 3 


   88 00000008         ;Input          : R0 - The new basepri to set.
   89 00000008         ;Output         : None.    
   90 00000008         ;Register Usage : None.                                 
                        
   91 00000008         ;*******************************************************
                       **********************/
   92 00000008         RMP_Mask_Int
   93 00000008 4770            BX               LR
   94 0000000A         ;/* End Function:RMP_Mask_Int **************************
                       **********************/
   95 0000000A         
   96 0000000A         ;/* Begin Function:RMP_MSB_Get *************************
                       ***********************
   97 0000000A         ;Description    : Get the MSB of the word.
   98 0000000A         ;Input          : ptr_t Val - The value.
   99 0000000A         ;Output         : None.
  100 0000000A         ;Return         : ptr_t - The MSB position.   
  101 0000000A         ;Register Usage : None. 
  102 0000000A         ;*******************************************************
                       **********************/
  103 0000000A                 MACRO
  104 0000000A         $Label  CHECK_BITS       $BITS
  105 0000000A                 LSRS             R2,R1,#$BITS
  106 0000000A                 BEQ              $Label.Skip
  107 0000000A                 ADDS             R0,#$BITS
  108 0000000A                 MOV              R1,R2
  109 0000000A         $Label.Skip
  110 0000000A                 MEND
  111 0000000A         
  112 0000000A         ;Always 21 instructions no matter what
  113 0000000A         RMP_MSB_Get
  114 0000000A 0001            MOVS             R1,R0
  115 0000000C 2000            MOVS             R0,#0
  116 0000000E         HEX     CHECK_BITS       16
  105 0000000E 0C0A            LSRS             R2,R1,#16
  106 00000010 D001            BEQ              HEXSkip
  107 00000012 3010            ADDS             R0,#16
  108 00000014 4611            MOV              R1,R2
  109 00000016         HEXSkip
  117 00000016         OCT     CHECK_BITS       8
  105 00000016 0A0A            LSRS             R2,R1,#8
  106 00000018 D001            BEQ              OCTSkip
  107 0000001A 3008            ADDS             R0,#8
  108 0000001C 4611            MOV              R1,R2
  109 0000001E         OCTSkip
  118 0000001E         QUAD    CHECK_BITS       4
  105 0000001E 090A            LSRS             R2,R1,#4
  106 00000020 D001            BEQ              QUADSkip
  107 00000022 3004            ADDS             R0,#4
  108 00000024 4611            MOV              R1,R2
  109 00000026         QUADSkip
  119 00000026         BIN     CHECK_BITS       2
  105 00000026 088A            LSRS             R2,R1,#2
  106 00000028 D001            BEQ              BINSkip
  107 0000002A 3002            ADDS             R0,#2
  108 0000002C 4611            MOV              R1,R2
  109 0000002E         BINSkip
  120 0000002E         ONE     CHECK_BITS       1
  105 0000002E 084A            LSRS             R2,R1,#1



ARM Macro Assembler    Page 4 


  106 00000030 D001            BEQ              ONESkip
  107 00000032 3001            ADDS             R0,#1
  108 00000034 4611            MOV              R1,R2
  109 00000036         ONESkip
  121 00000036         
  122 00000036         ;CLZ             R1,R0
  123 00000036         ;MOVS            R0,#31
  124 00000036         ;SUBS            R0,R1
  125 00000036 4770            BX               LR
  126 00000038         ;/* End Function:RMP_MSB_Get ***************************
                       **********************/
  127 00000038         
  128 00000038         ;/* Begin Function:_RMP_Yield **************************
                       ***********************
  129 00000038         ;Description : Trigger a yield to another thread.
  130 00000038         ;Input       : None.
  131 00000038         ;Output      : None.                                    
                         
  132 00000038         ;*******************************************************
                       **********************/
  133 00000038         _RMP_Yield
  134 00000038 B403            PUSH             {R0-R1}
  135 0000003A         
  136 0000003A 481D            LDR              R0,=0xE000ED04 ;The NVIC_INT_CT
                                                            RL register
  137 0000003C 491D            LDR              R1,=0x10000000 ;Trigger the Pen
                                                            dSV          
  138 0000003E 6001            STR              R1,[R0]
  139 00000040         
  140 00000040 F3BF 8F4F       DSB                          ;Data and instructi
                                                            on barrier
  141 00000044 F3BF 8F6F       ISB
  142 00000048         
  143 00000048 BC03            POP              {R0-R1}
  144 0000004A 4770            BX               LR
  145 0000004C         ;/* End Function:_RMP_Yield ****************************
                       **********************/
  146 0000004C         
  147 0000004C         ;/* Begin Function:_RMP_Start **************************
                       ***********************
  148 0000004C         ;Description : Jump to the user function and will never 
                       return from it.
  149 0000004C         ;Input       : None.
  150 0000004C         ;Output      : None.                                    
                         
  151 0000004C         ;*******************************************************
                       **********************/
  152 0000004C         _RMP_Start
  153 0000004C         ;Should never reach here
  154 0000004C 3940            SUBS             R1,#64      ;This is how we pus
                                                            h our registers so 
                                                            move forward
  155 0000004E F381 8809       MSR              PSP,R1      ;Set the stack poin
                                                            ter
  156 00000052 2402            MOVS             R4,#0x02    ;Previleged thread 
                                                            mode
  157 00000054 F384 8814       MSR              CONTROL,R4
  158 00000058         
  159 00000058 F3BF 8F4F       DSB                          ;Data and instructi



ARM Macro Assembler    Page 5 


                                                            on barrier
  160 0000005C F3BF 8F6F       ISB
  161 00000060         
  162 00000060 4780            BLX              R0          ;Branch to our targ
                                                            et
  163 00000062 E7FE            B                .           ;Capture faults    
                                                              
  164 00000064         ;/* End Function:_RMP_Start ****************************
                       **********************/
  165 00000064         
  166 00000064         ;/* Begin Function:PendSV_Handler **********************
                       ***********************
  167 00000064         ;Description : The PendSV interrupt routine. In fact, it
                        will call a C function
  168 00000064         ;              directly. The reason why the interrupt ro
                       utine must be an assembly
  169 00000064         ;              function is that the compiler may deal wi
                       th the stack in a different 
  170 00000064         ;              way when different optimization level is 
                       chosen. An assembly function
  171 00000064         ;              can make way around this problem.
  172 00000064         ;              However, if your compiler support inline 
                       assembly functions, this
  173 00000064         ;              can also be written in C.
  174 00000064         ;Input       : None.
  175 00000064         ;Output      : None.                                    
                         
  176 00000064         ;*******************************************************
                       **********************/
  177 00000064         PendSV_Handler
  178 00000064         ; Make space for register list
  179 00000064 F3EF 8009       MRS              R0,PSP      ;Spill all the regi
                                                            sters onto the user
                                                             stack
  180 00000068 3824            SUBS             R0,#36
  181 0000006A 4601            MOV              R1,R0
  182 0000006C C1F0            STMIA            R1!,{R4-R7} ;Save low register 
                                                            first due to limita
                                                            tion
  183 0000006E 4677            MOV              R7,LR
  184 00000070 465E            MOV              R6,R11
  185 00000072 4655            MOV              R5,R10
  186 00000074 464C            MOV              R4,R9
  187 00000076 4643            MOV              R3,R8
  188 00000078 C1F8            STMIA            R1!,{R3-R7}
  189 0000007A         
  190 0000007A F7FF FFFE       BL               RMP_Save_Ctx 
                                                            ;Save extra context
                                                            
  191 0000007E         
  192 0000007E 490E            LDR              R1,=RMP_Cur_SP ;Save The SP to 
                                                            control block.
  193 00000080 6008            STR              R0,[R1]
  194 00000082         
  195 00000082 F7FF FFFE       BL               _RMP_Get_High_Rdy ;Get the high
                                                            est ready task.
  196 00000086         
  197 00000086 490C            LDR              R1,=RMP_Cur_SP ;Load the SP.
  198 00000088 6808            LDR              R0,[R1]



ARM Macro Assembler    Page 6 


  199 0000008A         
  200 0000008A F7FF FFFE       BL               RMP_Load_Ctx 
                                                            ;Load extra context
                                                            
  201 0000008E         
  202 0000008E 4601            MOV              R1,R0
  203 00000090 3010            ADDS             R0,#16
  204 00000092 C8F8            LDMIA            R0!,{R3-R7} ;Load high register
                                                            s first due to limi
                                                            tation
  205 00000094 4698            MOV              R8,R3
  206 00000096 46A1            MOV              R9,R4
  207 00000098 46AA            MOV              R10,R5
  208 0000009A 46B3            MOV              R11,R6
  209 0000009C 46BE            MOV              LR,R7
  210 0000009E C9F0            LDMIA            R1!,{R4-R7}
  211 000000A0 F380 8809       MSR              PSP,R0
  212 000000A4         
  213 000000A4 4770            BX               LR          ;The LR will indica
                                                            te whether we are u
                                                            sing FPU.     
  214 000000A6         ;/* End Function:PendSV_Handler ************************
                       **********************/
  215 000000A6         
  216 000000A6         ;/* Begin Function:SysTick_Handler *********************
                       ***********************
  217 000000A6         ;Description : The SysTick interrupt routine. In fact, i
                       t will call a C function
  218 000000A6         ;              directly. The reason why the interrupt ro
                       utine must be an assembly
  219 000000A6         ;              function is that the compiler may deal wi
                       th the stack in a different 
  220 000000A6         ;              way when different optimization level is 
                       chosen. An assembly function
  221 000000A6         ;              can make way around this problem.
  222 000000A6         ;              However, if your compiler support inline 
                       assembly functions, this
  223 000000A6         ;              can also be written in C.
  224 000000A6         ;Input       : None.
  225 000000A6         ;Output      : None.                                    
                         
  226 000000A6         ;*******************************************************
                       **********************/
  227 000000A6         SysTick_Handler
  228 000000A6 B500            PUSH             {LR}
  229 000000A8         
  230 000000A8 2001            MOVS             R0,#0x01    ;We are not using t
                                                            ickless.
  231 000000AA F7FF FFFE       BL               _RMP_Tick_Handler
  232 000000AE         
  233 000000AE BD00            POP              {PC}
  234 000000B0         ;/* End Function:SysTick_Handler ***********************
                       **********************/
  235 000000B0         
  236 000000B0                 END
              E000ED04 
              10000000 
              00000000 
Command Line: --debug --xref --diag_suppress=9931 --cpu=Cortex-M0 --apcs=interw



ARM Macro Assembler    Page 7 


ork --depend=.\debug\output\platform_cm0_asm.d -o.\debug\output\platform_cm0_as
m.o -IF:\Code_Library\MCU\Mutatus\M5P1_MuProkaron\Project\RVMDK-STM32F030F4P6\R
TE -ID:\Program_Files_x86\Keil_v5\ARM\PACK\ARM\CMSIS\5.1.1\CMSIS\Include -ID:\P
rogram_Files_x86\Keil_v5\ARM\PACK\Keil\STM32F0xx_DFP\2.0.0\Drivers\CMSIS\Device
\ST\STM32F0xx\Include --predefine="__MICROLIB SETA 1" --predefine="__UVISION_VE
RSION SETA 520" --predefine="_RTE_ SETA 1" --predefine="STM32F030x6 SETA 1" --l
ist=.\debug\listings\platform_cm0_asm.lst ..\..\MProkaron\Platform\CortexM\plat
form_cm0_asm.s



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

ARCH 00000000

Symbol: ARCH
   Definitions
      At line 22 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      None
Comment: ARCH unused
BINSkip 0000002E

Symbol: BINSkip
   Definitions
      At line 109 in macro 0я▄аз
      at line 119 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 106 in macro 0я▄аз
      at line 119 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: BINSkip used once
HEXSkip 00000016

Symbol: HEXSkip
   Definitions
      At line 109 in macro 0я▄аз
      at line 116 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 106 in macro 0я▄аз
      at line 116 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: HEXSkip used once
OCTSkip 0000001E

Symbol: OCTSkip
   Definitions
      At line 109 in macro 0я▄аз
      at line 117 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 106 in macro 0я▄аз
      at line 117 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: OCTSkip used once
ONESkip 00000036

Symbol: ONESkip
   Definitions
      At line 109 in macro 0я▄аз
      at line 120 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 106 in macro 0я▄аз
      at line 120 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: ONESkip used once
PendSV_Handler 00000064

Symbol: PendSV_Handler
   Definitions
      At line 177 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 43 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: PendSV_Handler used once
QUADSkip 00000026

Symbol: QUADSkip



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Relocatable symbols

   Definitions
      At line 109 in macro 0я▄аз
      at line 118 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 106 in macro 0я▄аз
      at line 118 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: QUADSkip used once
RMP_Disable_Int 00000000

Symbol: RMP_Disable_Int
   Definitions
      At line 68 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 31 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Disable_Int used once
RMP_Enable_Int 00000004

Symbol: RMP_Enable_Int
   Definitions
      At line 80 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 33 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Enable_Int used once
RMP_MSB_Get 0000000A

Symbol: RMP_MSB_Get
   Definitions
      At line 113 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 37 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_MSB_Get used once
RMP_Mask_Int 00000008

Symbol: RMP_Mask_Int
   Definitions
      At line 92 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 35 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Mask_Int used once
SysTick_Handler 000000A6

Symbol: SysTick_Handler
   Definitions
      At line 227 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 45 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: SysTick_Handler used once
_RMP_Start 0000004C

Symbol: _RMP_Start
   Definitions
      At line 152 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 39 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Start used once
_RMP_Yield 00000038

Symbol: _RMP_Yield
   Definitions



ARM Macro Assembler    Page 3 Alphabetic symbol ordering
Relocatable symbols

      At line 133 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 41 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Yield used once
14 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
External symbols

RMP_Cur_SP 00000000

Symbol: RMP_Cur_SP
   Definitions
      At line 56 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 192 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
      At line 197 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s

RMP_Cur_Thd 00000000

Symbol: RMP_Cur_Thd
   Definitions
      At line 54 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      None
Comment: RMP_Cur_Thd unused
RMP_Load_Ctx 00000000

Symbol: RMP_Load_Ctx
   Definitions
      At line 59 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 200 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Load_Ctx used once
RMP_Save_Ctx 00000000

Symbol: RMP_Save_Ctx
   Definitions
      At line 58 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 190 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Save_Ctx used once
_RMP_Get_High_Rdy 00000000

Symbol: _RMP_Get_High_Rdy
   Definitions
      At line 50 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 195 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Get_High_Rdy used once
_RMP_Tick_Handler 00000000

Symbol: _RMP_Tick_Handler
   Definitions
      At line 52 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 231 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Tick_Handler used once
6 symbols
356 symbols in table
