


ARM Macro Assembler    Page 1 


    1 00000000         ;/******************************************************
                       ***********************
    2 00000000         ;Filename    : rmp_platform_cm0_asm.s
    3 00000000         ;Author      : pry
    4 00000000         ;Date        : 10/04/2012
    5 00000000         ;Description : The assembly part of the RMP RTOS. This i
                       s for Cortex-M0/0+/1.
    6 00000000         ;*******************************************************
                       **********************/
    7 00000000         
    8 00000000         ;/* The ARM Cortex-M0 Architecture *********************
                       ***********************
    9 00000000         ;R0-R7:General purpose registers that are accessible. 
   10 00000000         ;R8-R12:General purpose registers that can only be reach
                       ed by 32-bit instructions.
   11 00000000         ;R13:SP/SP_process/SP_main    Stack pointer
   12 00000000         ;R14:LR                       Link Register(used for ret
                       urning from a subfunction)
   13 00000000         ;R15:PC                       Program counter.
   14 00000000         ;IPSR                         Interrupt Program Status R
                       egister.
   15 00000000         ;APSR                         Application Program Status
                        Register.
   16 00000000         ;EPSR                         Execute Program Status Reg
                       ister.
   17 00000000         ;The above 3 registers are saved into the stack in combi
                       nation(xPSR).
   18 00000000         ;*******************************************************
                       **********************/
   19 00000000         
   20 00000000         ;/* Begin Header ***************************************
                       **********************/
   21 00000000         ;2^3=8 byte alignment.
   22 00000000                 AREA             ARCH,CODE,READONLY,ALIGN=3
   23 00000000         
   24 00000000                 THUMB
   25 00000000                 REQUIRE8
   26 00000000                 PRESERVE8
   27 00000000         ;/* End Header *****************************************
                       **********************/
   28 00000000         
   29 00000000         ;/* Begin Exports **************************************
                       **********************/
   30 00000000         ;Disable all interrupts
   31 00000000                 EXPORT           RMP_Disable_Int
   32 00000000         ;Enable all interrupts            
   33 00000000                 EXPORT           RMP_Enable_Int
   34 00000000         ;Mask/unmask interrupt dummy
   35 00000000                 EXPORT           RMP_Mask_Int
   36 00000000         ;Get the MSB                              
   37 00000000                 EXPORT           RMP_MSB_Get
   38 00000000         ;Start the first thread
   39 00000000                 EXPORT           _RMP_Start
   40 00000000         ;The PendSV trigger
   41 00000000                 EXPORT           _RMP_Yield
   42 00000000         ;The system pending service routine              
   43 00000000                 EXPORT           PendSV_Handler
   44 00000000         ;The systick timer routine              
   45 00000000                 EXPORT           SysTick_Handler



ARM Macro Assembler    Page 2 


   46 00000000         ;/* End Exports ****************************************
                       **********************/
   47 00000000         
   48 00000000         ;/* Begin Imports **************************************
                       **********************/
   49 00000000         ;The real task switch handling function
   50 00000000                 IMPORT           _RMP_Get_High_Rdy
   51 00000000         ;The real systick handler function
   52 00000000                 IMPORT           _RMP_Tick_Handler
   53 00000000         ;The PID of the current thread                     
   54 00000000                 IMPORT           RMP_Cur_Thd
   55 00000000         ;The stack address of current thread
   56 00000000                 IMPORT           RMP_Cur_SP
   57 00000000         ;Save and load extra contexts, such as FPU, peripherals 
                       and MPU
   58 00000000                 IMPORT           RMP_Save_Ctx
   59 00000000                 IMPORT           RMP_Load_Ctx
   60 00000000         ;/* End Imports ****************************************
                       **********************/
   61 00000000         
   62 00000000         ;/* Begin Function:RMP_Disable_Int *********************
                       ***********************
   63 00000000         ;Description : The function for disabling all interrupts
                       . Does not allow nesting.
   64 00000000         ;Input       : None.
   65 00000000         ;Output      : None.
   66 00000000         ;Return      : None.
   67 00000000         ;*******************************************************
                       **********************/    
   68 00000000         RMP_Disable_Int
   69 00000000         ;Disable all interrupts (I is primask,F is Faultmask.)
   70 00000000 B672            CPSID            I
   71 00000002 4770            BX               LR
   72 00000004         ;/* End Function:RMP_Disable_Int ***********************
                       **********************/
   73 00000004         
   74 00000004         ;/* Begin Function:RMP_Enable_Int **********************
                       ***********************
   75 00000004         ;Description : The function for enabling all interrupts.
                        Does not allow nesting.
   76 00000004         ;Input       : None.
   77 00000004         ;Output      : None.
   78 00000004         ;Return      : None.
   79 00000004         ;*******************************************************
                       **********************/
   80 00000004         RMP_Enable_Int
   81 00000004         ;Enable all interrupts.
   82 00000004 B662            CPSIE            I
   83 00000006 4770            BX               LR
   84 00000008         ;/* End Function:RMP_Enable_Int ************************
                       **********************/
   85 00000008         
   86 00000008         ;/* Begin Function:RMP_Mask_Int ************************
                       ***********************
   87 00000008         ;Description : Cortex-M0 does not allow masking and this
                        is provided as dummy.
   88 00000008         ;Input       : rmp_ptr_t R0 - The new BASEPRI to set.
   89 00000008         ;Output      : None.
   90 00000008         ;Return      : None.



ARM Macro Assembler    Page 3 


   91 00000008         ;*******************************************************
                       **********************/
   92 00000008         RMP_Mask_Int
   93 00000008 4770            BX               LR
   94 0000000A         ;/* End Function:RMP_Mask_Int **************************
                       **********************/
   95 0000000A         
   96 0000000A         ;/* Begin Function:RMP_MSB_Get *************************
                       ***********************
   97 0000000A         ;Description : Get the MSB of the word.
   98 0000000A         ;Input       : rmp_ptr_t R0 - The value.
   99 0000000A         ;Output      : None.
  100 0000000A         ;Return      : rmp_ptr_t R0 - The MSB position. 
  101 0000000A         ;*******************************************************
                       **********************/
  102 0000000A                 MACRO
  103 0000000A         $Label  CHECK_BITS       $BITS
  104 0000000A                 LSRS             R2,R1,#$BITS
  105 0000000A                 BEQ              $Label.Skip
  106 0000000A                 ADDS             R0,#$BITS
  107 0000000A                 MOV              R1,R2
  108 0000000A         $Label.Skip
  109 0000000A                 MEND
  110 0000000A         
  111 0000000A         ;Always 21 instructions no matter what
  112 0000000A         RMP_MSB_Get
  113 0000000A         ;See if the word passed in is zero. In this case, we ret
                       urn -1.
  114 0000000A 2800            CMP              R0,#0
  115 0000000C D016            BEQ              ZERO
  116 0000000E 0001            MOVS             R1,R0
  117 00000010 2000            MOVS             R0,#0
  118 00000012         HEX     CHECK_BITS       16
  104 00000012 0C0A            LSRS             R2,R1,#16
  105 00000014 D001            BEQ              HEXSkip
  106 00000016 3010            ADDS             R0,#16
  107 00000018 4611            MOV              R1,R2
  108 0000001A         HEXSkip
  119 0000001A         OCT     CHECK_BITS       8
  104 0000001A 0A0A            LSRS             R2,R1,#8
  105 0000001C D001            BEQ              OCTSkip
  106 0000001E 3008            ADDS             R0,#8
  107 00000020 4611            MOV              R1,R2
  108 00000022         OCTSkip
  120 00000022         QUAD    CHECK_BITS       4
  104 00000022 090A            LSRS             R2,R1,#4
  105 00000024 D001            BEQ              QUADSkip
  106 00000026 3004            ADDS             R0,#4
  107 00000028 4611            MOV              R1,R2
  108 0000002A         QUADSkip
  121 0000002A         BIN     CHECK_BITS       2
  104 0000002A 088A            LSRS             R2,R1,#2
  105 0000002C D001            BEQ              BINSkip
  106 0000002E 3002            ADDS             R0,#2
  107 00000030 4611            MOV              R1,R2
  108 00000032         BINSkip
  122 00000032         ONE     CHECK_BITS       1
  104 00000032 084A            LSRS             R2,R1,#1
  105 00000034 D001            BEQ              ONESkip



ARM Macro Assembler    Page 4 


  106 00000036 3001            ADDS             R0,#1
  107 00000038 4611            MOV              R1,R2
  108 0000003A         ONESkip
  123 0000003A 4770            BX               LR
  124 0000003C         ZERO
  125 0000003C 3801            SUBS             R0,#1
  126 0000003E 4770            BX               LR
  127 00000040         ;/* End Function:RMP_MSB_Get ***************************
                       **********************/
  128 00000040         
  129 00000040         ;/* Begin Function:_RMP_Yield **************************
                       ***********************
  130 00000040         ;Description : Trigger a yield to another thread.
  131 00000040         ;Input       : None.
  132 00000040         ;Output      : None.
  133 00000040         ;Return      : None.
  134 00000040         ;*******************************************************
                       **********************/
  135 00000040         _RMP_Yield
  136 00000040 481A            LDR              R0,=0xE000ED04 ;The NVIC_INT_CT
                                                            RL register
  137 00000042 491B            LDR              R1,=0x10000000 ;Trigger the Pen
                                                            dSV          
  138 00000044 6001            STR              R1,[R0]
  139 00000046         
  140 00000046 F3BF 8F6F       ISB                          ;Instruction barrie
                                                            r
  141 0000004A 4770            BX               LR
  142 0000004C         ;/* End Function:_RMP_Yield ****************************
                       **********************/
  143 0000004C         
  144 0000004C         ;/* Begin Function:_RMP_Start **************************
                       ***********************
  145 0000004C         ;Description : Jump to the user function and will never 
                       return from it.
  146 0000004C         ;Input       : None.
  147 0000004C         ;Output      : None.
  148 0000004C         ;Return      : None.
  149 0000004C         ;*******************************************************
                       **********************/
  150 0000004C         _RMP_Start
  151 0000004C         ;Should never reach here
  152 0000004C 3940            SUBS             R1,#64      ;This is how we pus
                                                            h our registers so 
                                                            move forward
  153 0000004E F381 8809       MSR              PSP,R1      ;Set the stack poin
                                                            ter
  154 00000052 2402            MOVS             R4,#0x02    ;Previleged thread 
                                                            mode
  155 00000054 F384 8814       MSR              CONTROL,R4
  156 00000058         
  157 00000058 F3BF 8F6F       ISB                          ;Data and instructi
                                                            on barrier
  158 0000005C 4780            BLX              R0          ;Branch to our targ
                                                            et
  159 0000005E         ;/* End Function:_RMP_Start ****************************
                       **********************/
  160 0000005E         
  161 0000005E         ;/* Begin Function:PendSV_Handler **********************



ARM Macro Assembler    Page 5 


                       ***********************
  162 0000005E         ;Description : The PendSV interrupt routine. In fact, it
                        will call a C function
  163 0000005E         ;              directly. The reason why the interrupt ro
                       utine must be an assembly
  164 0000005E         ;              function is that the compiler may deal wi
                       th the stack in a different 
  165 0000005E         ;              way when different optimization level is 
                       chosen. An assembly function
  166 0000005E         ;              can make way around this problem.
  167 0000005E         ;              However, if your compiler support inline 
                       assembly functions, this
  168 0000005E         ;              can also be written in C.
  169 0000005E         ;Input       : None.
  170 0000005E         ;Output      : None.
  171 0000005E         ;Return      : None.
  172 0000005E         ;*******************************************************
                       **********************/
  173 0000005E         PendSV_Handler
  174 0000005E         ; Make space for register list
  175 0000005E F3EF 8009       MRS              R0,PSP      ;Spill all the regi
                                                            sters onto the user
                                                             stack
  176 00000062 3824            SUBS             R0,#36
  177 00000064 4601            MOV              R1,R0
  178 00000066 C1F0            STMIA            R1!,{R4-R7} ;Save low register 
                                                            first due to limita
                                                            tion
  179 00000068 4677            MOV              R7,LR
  180 0000006A 465E            MOV              R6,R11
  181 0000006C 4655            MOV              R5,R10
  182 0000006E 464C            MOV              R4,R9
  183 00000070 4643            MOV              R3,R8
  184 00000072 C1F8            STMIA            R1!,{R3-R7}
  185 00000074         
  186 00000074 F7FF FFFE       BL               RMP_Save_Ctx 
                                                            ;Save extra context
                                                            
  187 00000078         
  188 00000078 490E            LDR              R1,=RMP_Cur_SP ;Save The SP to 
                                                            control block.
  189 0000007A 6008            STR              R0,[R1]
  190 0000007C         
  191 0000007C F7FF FFFE       BL               _RMP_Get_High_Rdy ;Get the high
                                                            est ready task.
  192 00000080         
  193 00000080 490C            LDR              R1,=RMP_Cur_SP ;Load the SP.
  194 00000082 6808            LDR              R0,[R1]
  195 00000084         
  196 00000084 F7FF FFFE       BL               RMP_Load_Ctx 
                                                            ;Load extra context
                                                            
  197 00000088         
  198 00000088 4601            MOV              R1,R0
  199 0000008A 3010            ADDS             R0,#16
  200 0000008C C8F8            LDMIA            R0!,{R3-R7} ;Load high register
                                                            s first due to limi
                                                            tation
  201 0000008E 4698            MOV              R8,R3



ARM Macro Assembler    Page 6 


  202 00000090 46A1            MOV              R9,R4
  203 00000092 46AA            MOV              R10,R5
  204 00000094 46B3            MOV              R11,R6
  205 00000096 46BE            MOV              LR,R7
  206 00000098 C9F0            LDMIA            R1!,{R4-R7}
  207 0000009A F380 8809       MSR              PSP,R0
  208 0000009E         
  209 0000009E 4770            BX               LR          ;Cortex-M0 will nev
                                                            er have a FPU.
  210 000000A0         ;/* End Function:PendSV_Handler ************************
                       **********************/
  211 000000A0         
  212 000000A0         ;/* Begin Function:SysTick_Handler *********************
                       ***********************
  213 000000A0         ;Description : The SysTick interrupt routine. In fact, i
                       t will call a C function
  214 000000A0         ;              directly. The reason why the interrupt ro
                       utine must be an assembly
  215 000000A0         ;              function is that the compiler may deal wi
                       th the stack in a different 
  216 000000A0         ;              way when different optimization level is 
                       chosen. An assembly function
  217 000000A0         ;              can make way around this problem.
  218 000000A0         ;              However, if your compiler support inline 
                       assembly functions, this
  219 000000A0         ;              can also be written in C.
  220 000000A0         ;Input       : None.
  221 000000A0         ;Output      : None.
  222 000000A0         ;Return      : None.
  223 000000A0         ;*******************************************************
                       **********************/
  224 000000A0         SysTick_Handler
  225 000000A0 B500            PUSH             {LR}
  226 000000A2         
  227 000000A2 2001            MOVS             R0,#0x01    ;We are not using t
                                                            ickless.
  228 000000A4 F7FF FFFE       BL               _RMP_Tick_Handler
  229 000000A8         
  230 000000A8 BD00            POP              {PC}
  231 000000AA 00 00           ALIGN
  232 000000AC         ;/* End Function:SysTick_Handler ***********************
                       **********************/
  233 000000AC         
  234 000000AC                 END
              E000ED04 
              10000000 
              00000000 
Command Line: --debug --xref --diag_suppress=9931 --cpu=Cortex-M0 --apcs=interw
ork --depend=.\debug\output\rmp_platform_cm0_asm.d -o.\debug\output\rmp_platfor
m_cm0_asm.o -IF:\Code_Library\MCU\Mutatus\M5P1_MuProkaron\Project\RVMDK-STM32F0
30F4P6\RTE -ID:\Program_Files_x86\Keil_v5\ARM\PACK\ARM\CMSIS\5.3.0\CMSIS\Includ
e -ID:\Program_Files_x86\Keil_v5\ARM\PACK\Keil\STM32F0xx_DFP\2.0.0\Drivers\CMSI
S\Device\ST\STM32F0xx\Include --predefine="__MICROLIB SETA 1" --predefine="__UV
ISION_VERSION SETA 520" --predefine="_RTE_ SETA 1" --predefine="STM32F030x6 SET
A 1" --list=.\debug\listings\rmp_platform_cm0_asm.lst ..\..\MProkaron\Platform\
CortexM\rmp_platform_cm0_asm.s



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

ARCH 00000000

Symbol: ARCH
   Definitions
      At line 22 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      None
Comment: ARCH unused
BINSkip 00000032

Symbol: BINSkip
   Definitions
      At line 108 in macro #¬8¯
      at line 121 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 105 in macro #¬8¯
      at line 121 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: BINSkip used once
HEXSkip 0000001A

Symbol: HEXSkip
   Definitions
      At line 108 in macro #¬8¯
      at line 118 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 105 in macro #¬8¯
      at line 118 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: HEXSkip used once
OCTSkip 00000022

Symbol: OCTSkip
   Definitions
      At line 108 in macro #¬8¯
      at line 119 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 105 in macro #¬8¯
      at line 119 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: OCTSkip used once
ONESkip 0000003A

Symbol: ONESkip
   Definitions
      At line 108 in macro #¬8¯
      at line 122 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 105 in macro #¬8¯
      at line 122 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: ONESkip used once
PendSV_Handler 0000005E




ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Relocatable symbols

Symbol: PendSV_Handler
   Definitions
      At line 173 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 43 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: PendSV_Handler used once
QUADSkip 0000002A

Symbol: QUADSkip
   Definitions
      At line 108 in macro #¬8¯
      at line 120 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 105 in macro #¬8¯
      at line 120 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: QUADSkip used once
RMP_Disable_Int 00000000

Symbol: RMP_Disable_Int
   Definitions
      At line 68 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 31 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: RMP_Disable_Int used once
RMP_Enable_Int 00000004

Symbol: RMP_Enable_Int
   Definitions
      At line 80 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 33 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: RMP_Enable_Int used once
RMP_MSB_Get 0000000A

Symbol: RMP_MSB_Get
   Definitions
      At line 112 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 37 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: RMP_MSB_Get used once
RMP_Mask_Int 00000008

Symbol: RMP_Mask_Int
   Definitions
      At line 92 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 35 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s



ARM Macro Assembler    Page 3 Alphabetic symbol ordering
Relocatable symbols

Comment: RMP_Mask_Int used once
SysTick_Handler 000000A0

Symbol: SysTick_Handler
   Definitions
      At line 224 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 45 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: SysTick_Handler used once
ZERO 0000003C

Symbol: ZERO
   Definitions
      At line 124 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 115 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: ZERO used once
_RMP_Start 0000004C

Symbol: _RMP_Start
   Definitions
      At line 150 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 39 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: _RMP_Start used once
_RMP_Yield 00000040

Symbol: _RMP_Yield
   Definitions
      At line 135 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
   Uses
      At line 41 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
Comment: _RMP_Yield used once
15 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
External symbols

RMP_Cur_SP 00000000

Symbol: RMP_Cur_SP
   Definitions
      At line 56 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 188 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
      At line 193 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s

RMP_Cur_Thd 00000000

Symbol: RMP_Cur_Thd
   Definitions
      At line 54 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      None
Comment: RMP_Cur_Thd unused
RMP_Load_Ctx 00000000

Symbol: RMP_Load_Ctx
   Definitions
      At line 59 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 196 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: RMP_Load_Ctx used once
RMP_Save_Ctx 00000000

Symbol: RMP_Save_Ctx
   Definitions
      At line 58 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 186 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: RMP_Save_Ctx used once
_RMP_Get_High_Rdy 00000000

Symbol: _RMP_Get_High_Rdy
   Definitions
      At line 50 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 191 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm
.s
Comment: _RMP_Get_High_Rdy used once
_RMP_Tick_Handler 00000000

Symbol: _RMP_Tick_Handler
   Definitions
      At line 52 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm.
s
   Uses
      At line 228 in file ..\..\MProkaron\Platform\CortexM\rmp_platform_cm0_asm



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
External symbols

.s
Comment: _RMP_Tick_Handler used once
6 symbols
357 symbols in table
