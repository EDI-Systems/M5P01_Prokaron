


ARM Macro Assembler    Page 1 


    1 00000000         ;/******************************************************
                       ***********************
    2 00000000         ;Filename    : platform_cm0_asm.s
    3 00000000         ;Author      : pry
    4 00000000         ;Date        : 10/04/2012
    5 00000000         ;Description : The assembly part of the RMP RTOS. This i
                       s for Cortex-M0/0+/1.
    6 00000000         ;*******************************************************
                       **********************/
    7 00000000         
    8 00000000         ;/* The ARM Cortex-M Structure *************************
                       ***********************
    9 00000000         ;R0-R7:General purpose registers that are accessible. 
   10 00000000         ;R8-R12:general purpose registers that can only be reach
                       ed by 32-bit instructions.
   11 00000000         ;R13:SP/SP_process/SP_main    Stack pointer
   12 00000000         ;R14:LR                       Link Register(used for ret
                       urning from a subfunction)
   13 00000000         ;R15:PC                       Program counter.
   14 00000000         ;IPSR                         Interrupt Program Status R
                       egister.
   15 00000000         ;APSR                         Application Program Status
                        Register.
   16 00000000         ;EPSR                         Execute Program Status Reg
                       ister.
   17 00000000         ;The above 3 registers are saved into the stack in combi
                       nation(xPSR).
   18 00000000         ;*******************************************************
                       **********************/
   19 00000000         
   20 00000000         ;/* Begin Header ***************************************
                       **********************/
   21 00000000         ;The align is "(2^3)/8=1(Byte)." In fact it does not tak
                       e effect.            
   22 00000000                 AREA             ARCH,CODE,READONLY,ALIGN=3
   23 00000000         
   24 00000000                 THUMB
   25 00000000                 REQUIRE8
   26 00000000                 PRESERVE8
   27 00000000         ;/* End Header *****************************************
                       **********************/
   28 00000000         
   29 00000000         ;/* Begin Exports **************************************
                       **********************/
   30 00000000         ;Disable all interrupts
   31 00000000                 EXPORT           RMP_Disable_Int
   32 00000000         ;Enable all interrupts            
   33 00000000                 EXPORT           RMP_Enable_Int
   34 00000000         ;Get the MSB                              
   35 00000000                 EXPORT           RMP_MSB_Get
   36 00000000         ;Start the first thread
   37 00000000                 EXPORT           _RMP_Start
   38 00000000         ;The PendSV trigger
   39 00000000                 EXPORT           _RMP_Yield
   40 00000000         ;The system pending service routine              
   41 00000000                 EXPORT           PendSV_Handler
   42 00000000         ;The systick timer routine              
   43 00000000                 EXPORT           SysTick_Handler
   44 00000000         ;/* End Exports ****************************************



ARM Macro Assembler    Page 2 


                       **********************/
   45 00000000         
   46 00000000         ;/* Begin Imports **************************************
                       **********************/
   47 00000000         ;The real task switch handling function
   48 00000000                 IMPORT           _RMP_Get_High_Rdy
   49 00000000         ;The real systick handler function
   50 00000000                 IMPORT           _RMP_Tick_Handler
   51 00000000         ;The PID of the current thread                     
   52 00000000                 IMPORT           RMP_Cur_Thd
   53 00000000         ;The stack address of current thread
   54 00000000                 IMPORT           RMP_Cur_SP
   55 00000000         ;Save and load extra contexts, such as FPU, peripherals 
                       and MPU
   56 00000000                 IMPORT           RMP_Save_Ctx
   57 00000000                 IMPORT           RMP_Load_Ctx
   58 00000000         ;/* End Imports ****************************************
                       **********************/
   59 00000000         
   60 00000000         ;/* Begin Function:RMP_Disable_Int *********************
                       ***********************
   61 00000000         ;Description    : The function for disabling all interru
                       pts. Does not allow nesting.
   62 00000000         ;Input          : None.
   63 00000000         ;Output         : None.    
   64 00000000         ;Register Usage : None.                                 
                        
   65 00000000         ;*******************************************************
                       **********************/    
   66 00000000         RMP_Disable_Int
   67 00000000         ;Disable all interrupts (I is primask,F is Faultmask.)
   68 00000000 B672            CPSID            I
   69 00000002 4770            BX               LR
   70 00000004         ;/* End Function:RMP_Disable_Int ***********************
                       **********************/
   71 00000004         
   72 00000004         ;/* Begin Function:RMP_Enable_Int **********************
                       ***********************
   73 00000004         ;Description    : The function for enabling all interrup
                       ts. Does not allow nesting.
   74 00000004         ;Input          : None.
   75 00000004         ;Output         : None.    
   76 00000004         ;Register Usage : None.                                 
                        
   77 00000004         ;*******************************************************
                       **********************/
   78 00000004         RMP_Enable_Int
   79 00000004         ;Enable all interrupts.
   80 00000004 B662            CPSIE            I
   81 00000006 4770            BX               LR
   82 00000008         ;/* End Function:RMP_Enable_Int ************************
                       **********************/
   83 00000008         
   84 00000008         ;/* Begin Function:RMP_MSB_Get *************************
                       ***********************
   85 00000008         ;Description    : Get the MSB of the word.
   86 00000008         ;Input          : ptr_t Val - The value.
   87 00000008         ;Output         : None.
   88 00000008         ;Return         : ptr_t - The MSB position.   



ARM Macro Assembler    Page 3 


   89 00000008         ;Register Usage : None. 
   90 00000008         ;*******************************************************
                       **********************/
   91 00000008                 MACRO
   92 00000008         $Label  CHECK_BITS       $BITS
   93 00000008                 LSRS             R2,R1,#$BITS
   94 00000008                 BEQ              $Label.Skip
   95 00000008                 ADDS             R0,#$BITS
   96 00000008                 MOV              R1,R2
   97 00000008         $Label.Skip
   98 00000008                 MEND
   99 00000008         
  100 00000008         ;Always 21 instructions no matter what
  101 00000008         RMP_MSB_Get
  102 00000008 0001            MOVS             R1,R0
  103 0000000A 2000            MOVS             R0,#0
  104 0000000C         HEX     CHECK_BITS       16
   93 0000000C 0C0A            LSRS             R2,R1,#16
   94 0000000E D001            BEQ              HEXSkip
   95 00000010 3010            ADDS             R0,#16
   96 00000012 4611            MOV              R1,R2
   97 00000014         HEXSkip
  105 00000014         OCT     CHECK_BITS       8
   93 00000014 0A0A            LSRS             R2,R1,#8
   94 00000016 D001            BEQ              OCTSkip
   95 00000018 3008            ADDS             R0,#8
   96 0000001A 4611            MOV              R1,R2
   97 0000001C         OCTSkip
  106 0000001C         QUAD    CHECK_BITS       4
   93 0000001C 090A            LSRS             R2,R1,#4
   94 0000001E D001            BEQ              QUADSkip
   95 00000020 3004            ADDS             R0,#4
   96 00000022 4611            MOV              R1,R2
   97 00000024         QUADSkip
  107 00000024         BIN     CHECK_BITS       2
   93 00000024 088A            LSRS             R2,R1,#2
   94 00000026 D001            BEQ              BINSkip
   95 00000028 3002            ADDS             R0,#2
   96 0000002A 4611            MOV              R1,R2
   97 0000002C         BINSkip
  108 0000002C         ONE     CHECK_BITS       1
   93 0000002C 084A            LSRS             R2,R1,#1
   94 0000002E D001            BEQ              ONESkip
   95 00000030 3001            ADDS             R0,#1
   96 00000032 4611            MOV              R1,R2
   97 00000034         ONESkip
  109 00000034         
  110 00000034         ;CLZ             R1,R0
  111 00000034         ;MOVS            R0,#31
  112 00000034         ;SUBS            R0,R1
  113 00000034 4770            BX               LR
  114 00000036         ;/* End Function:RMP_MSB_Get ***************************
                       **********************/
  115 00000036         
  116 00000036         ;/* Begin Function:_RMP_Yield **************************
                       ***********************
  117 00000036         ;Description : Trigger a yield to another thread.
  118 00000036         ;Input       : None.
  119 00000036         ;Output      : None.                                    



ARM Macro Assembler    Page 4 


                         
  120 00000036         ;*******************************************************
                       **********************/
  121 00000036         _RMP_Yield
  122 00000036 B403            PUSH             {R0-R1}
  123 00000038         
  124 00000038 481D            LDR              R0,=0xE000ED04 ;The NVIC_INT_CT
                                                            RL register
  125 0000003A 491E            LDR              R1,=0x10000000 ;Trigger the Pen
                                                            dSV          
  126 0000003C 6001            STR              R1,[R0]
  127 0000003E         
  128 0000003E F3BF 8F4F       DSB                          ;Data and instructi
                                                            on barrier
  129 00000042 F3BF 8F6F       ISB
  130 00000046         
  131 00000046 BC03            POP              {R0-R1}
  132 00000048 4770            BX               LR
  133 0000004A         ;/* End Function:_RMP_Yield ****************************
                       **********************/
  134 0000004A         
  135 0000004A         ;/* Begin Function:_RMP_Start **************************
                       ***********************
  136 0000004A         ;Description : Jump to the user function and will never 
                       return from it.
  137 0000004A         ;Input       : None.
  138 0000004A         ;Output      : None.                                    
                         
  139 0000004A         ;*******************************************************
                       **********************/
  140 0000004A         _RMP_Start
  141 0000004A         ;Should never reach here
  142 0000004A 3940            SUBS             R1,#64      ;This is how we pus
                                                            h our registers so 
                                                            move forward
  143 0000004C F381 8809       MSR              PSP,R1      ;Set the stack poin
                                                            ter
  144 00000050 2402            MOVS             R4,#0x02    ;Previleged thread 
                                                            mode
  145 00000052 F384 8814       MSR              CONTROL,R4
  146 00000056         
  147 00000056 F3BF 8F4F       DSB                          ;Data and instructi
                                                            on barrier
  148 0000005A F3BF 8F6F       ISB
  149 0000005E         
  150 0000005E 4780            BLX              R0          ;Branch to our targ
                                                            et
  151 00000060 E7FE            B                .           ;Capture faults    
                                                              
  152 00000062         ;/* End Function:_RMP_Start ****************************
                       **********************/
  153 00000062         
  154 00000062         ;/* Begin Function:PendSV_Handler **********************
                       ***********************
  155 00000062         ;Description : The PendSV interrupt routine. In fact, it
                        will call a C function
  156 00000062         ;              directly. The reason why the interrupt ro
                       utine must be an assembly
  157 00000062         ;              function is that the compiler may deal wi



ARM Macro Assembler    Page 5 


                       th the stack in a different 
  158 00000062         ;              way when different optimization level is 
                       chosen. An assembly function
  159 00000062         ;              can make way around this problem.
  160 00000062         ;              However, if your compiler support inline 
                       assembly functions, this
  161 00000062         ;              can also be written in C.
  162 00000062         ;Input       : None.
  163 00000062         ;Output      : None.                                    
                         
  164 00000062         ;*******************************************************
                       **********************/
  165 00000062         PendSV_Handler
  166 00000062         ; Make space for register list
  167 00000062 F3EF 8009       MRS              R0,PSP      ;Spill all the regi
                                                            sters onto the user
                                                             stack
  168 00000066 3824            SUBS             R0,#36
  169 00000068 4601            MOV              R1,R0
  170 0000006A C1F0            STMIA            R1!,{R4-R7} ;Save low register 
                                                            first due to limita
                                                            tion
  171 0000006C 4677            MOV              R7,LR
  172 0000006E 465E            MOV              R6,R11
  173 00000070 4655            MOV              R5,R10
  174 00000072 464C            MOV              R4,R9
  175 00000074 4643            MOV              R3,R8
  176 00000076 C1F8            STMIA            R1!,{R3-R7}
  177 00000078         
  178 00000078 F7FF FFFE       BL               RMP_Save_Ctx 
                                                            ;Save extra context
                                                            
  179 0000007C         
  180 0000007C 490E            LDR              R1,=RMP_Cur_SP ;Save The SP to 
                                                            control block.
  181 0000007E 6008            STR              R0,[R1]
  182 00000080         
  183 00000080 F7FF FFFE       BL               _RMP_Get_High_Rdy ;Get the high
                                                            est ready task.
  184 00000084         
  185 00000084 490C            LDR              R1,=RMP_Cur_SP ;Load the SP.
  186 00000086 6808            LDR              R0,[R1]
  187 00000088         
  188 00000088 F7FF FFFE       BL               RMP_Load_Ctx 
                                                            ;Load extra context
                                                            
  189 0000008C         
  190 0000008C 4601            MOV              R1,R0
  191 0000008E 3010            ADDS             R0,#16
  192 00000090 C8F8            LDMIA            R0!,{R3-R7} ;Load high register
                                                            s first due to limi
                                                            tation
  193 00000092 4698            MOV              R8,R3
  194 00000094 46A1            MOV              R9,R4
  195 00000096 46AA            MOV              R10,R5
  196 00000098 46B3            MOV              R11,R6
  197 0000009A 46BE            MOV              LR,R7
  198 0000009C C9F0            LDMIA            R1!,{R4-R7}
  199 0000009E F380 8809       MSR              PSP,R0



ARM Macro Assembler    Page 6 


  200 000000A2         
  201 000000A2 4770            BX               LR          ;The LR will indica
                                                            te whether we are u
                                                            sing FPU.     
  202 000000A4         ;/* End Function:PendSV_Handler ************************
                       **********************/
  203 000000A4         
  204 000000A4         ;/* Begin Function:SysTick_Handler *********************
                       ***********************
  205 000000A4         ;Description : The SysTick interrupt routine. In fact, i
                       t will call a C function
  206 000000A4         ;              directly. The reason why the interrupt ro
                       utine must be an assembly
  207 000000A4         ;              function is that the compiler may deal wi
                       th the stack in a different 
  208 000000A4         ;              way when different optimization level is 
                       chosen. An assembly function
  209 000000A4         ;              can make way around this problem.
  210 000000A4         ;              However, if your compiler support inline 
                       assembly functions, this
  211 000000A4         ;              can also be written in C.
  212 000000A4         ;Input       : None.
  213 000000A4         ;Output      : None.                                    
                         
  214 000000A4         ;*******************************************************
                       **********************/
  215 000000A4         SysTick_Handler
  216 000000A4 B500            PUSH             {LR}
  217 000000A6         
  218 000000A6 2001            MOVS             R0,#0x01    ;We are not using t
                                                            ickless.
  219 000000A8 F7FF FFFE       BL               _RMP_Tick_Handler
  220 000000AC         
  221 000000AC BD00            POP              {PC}
  222 000000AE BF00            NOP
  223 000000B0         ;/* End Function:SysTick_Handler ***********************
                       **********************/
  224 000000B0         
  225 000000B0                 END
              E000ED04 
              10000000 
              00000000 
Command Line: --debug --xref --diag_suppress=9931 --cpu=Cortex-M0 --apcs=interw
ork --depend=.\debug\output\platform_cm0_asm.d -o.\debug\output\platform_cm0_as
m.o -IF:\Code_Library\MCU\Mutatus\M5P1_MuProkaron\Project\RVMDK-STM32F030F4P6\R
TE -ID:\Program_Files_x86\Keil_v5\ARM\PACK\ARM\CMSIS\5.1.1\CMSIS\Include -ID:\P
rogram_Files_x86\Keil_v5\ARM\PACK\Keil\STM32F0xx_DFP\2.0.0\Drivers\CMSIS\Device
\ST\STM32F0xx\Include --predefine="__MICROLIB SETA 1" --predefine="__UVISION_VE
RSION SETA 520" --predefine="_RTE_ SETA 1" --predefine="STM32F030x6 SETA 1" --l
ist=.\debug\listings\platform_cm0_asm.lst ..\..\MProkaron\Platform\CortexM\plat
form_cm0_asm.s



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

ARCH 00000000

Symbol: ARCH
   Definitions
      At line 22 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      None
Comment: ARCH unused
BINSkip 0000002C

Symbol: BINSkip
   Definitions
      At line 97 in macro ä©h¨
      at line 107 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 94 in macro ä©h¨
      at line 107 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: BINSkip used once
HEXSkip 00000014

Symbol: HEXSkip
   Definitions
      At line 97 in macro ä©h¨
      at line 104 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 94 in macro ä©h¨
      at line 104 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: HEXSkip used once
OCTSkip 0000001C

Symbol: OCTSkip
   Definitions
      At line 97 in macro ä©h¨
      at line 105 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 94 in macro ä©h¨
      at line 105 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: OCTSkip used once
ONESkip 00000034

Symbol: ONESkip
   Definitions
      At line 97 in macro ä©h¨
      at line 108 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 94 in macro ä©h¨
      at line 108 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: ONESkip used once
PendSV_Handler 00000062

Symbol: PendSV_Handler
   Definitions
      At line 165 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 41 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: PendSV_Handler used once
QUADSkip 00000024

Symbol: QUADSkip



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Relocatable symbols

   Definitions
      At line 97 in macro ä©h¨
      at line 106 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 94 in macro ä©h¨
      at line 106 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: QUADSkip used once
RMP_Disable_Int 00000000

Symbol: RMP_Disable_Int
   Definitions
      At line 66 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 31 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Disable_Int used once
RMP_Enable_Int 00000004

Symbol: RMP_Enable_Int
   Definitions
      At line 78 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 33 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Enable_Int used once
RMP_MSB_Get 00000008

Symbol: RMP_MSB_Get
   Definitions
      At line 101 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 35 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_MSB_Get used once
SysTick_Handler 000000A4

Symbol: SysTick_Handler
   Definitions
      At line 215 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 43 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: SysTick_Handler used once
_RMP_Start 0000004A

Symbol: _RMP_Start
   Definitions
      At line 140 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 37 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Start used once
_RMP_Yield 00000036

Symbol: _RMP_Yield
   Definitions
      At line 121 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 39 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Yield used once
13 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
External symbols

RMP_Cur_SP 00000000

Symbol: RMP_Cur_SP
   Definitions
      At line 54 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 180 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
      At line 185 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s

RMP_Cur_Thd 00000000

Symbol: RMP_Cur_Thd
   Definitions
      At line 52 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      None
Comment: RMP_Cur_Thd unused
RMP_Load_Ctx 00000000

Symbol: RMP_Load_Ctx
   Definitions
      At line 57 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 188 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Load_Ctx used once
RMP_Save_Ctx 00000000

Symbol: RMP_Save_Ctx
   Definitions
      At line 56 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 178 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: RMP_Save_Ctx used once
_RMP_Get_High_Rdy 00000000

Symbol: _RMP_Get_High_Rdy
   Definitions
      At line 48 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 183 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Get_High_Rdy used once
_RMP_Tick_Handler 00000000

Symbol: _RMP_Tick_Handler
   Definitions
      At line 50 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
   Uses
      At line 219 in file ..\..\MProkaron\Platform\CortexM\platform_cm0_asm.s
Comment: _RMP_Tick_Handler used once
6 symbols
355 symbols in table
